<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENTINELLE ULTRA V11.8 - A.LEMONFA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --blue: #00d2ff; --red: #ff3c5c; --gold: #ffcc00; --bg: #010204; --card: #0d121b; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        
        /* HEADER TACTIQUE */
        .header { background: linear-gradient(90deg, #001f3f, #00d2ff); padding: 20px; text-align: center; border-bottom: 3px solid var(--blue); font-weight: bold; letter-spacing: 2px; }

        /* √âCRAN PIN S√âCURIS√â */
        #pinOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition: 0.5s; }
        .pin-dot { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--blue); display: inline-block; margin: 5px; }
        .num-pad { display: grid; grid-template-columns: repeat(3, 85px); gap: 15px; margin-top: 30px; }
        .btn-num { width: 85px; height: 85px; border-radius: 50%; border: 1px solid var(--blue); background: none; color: white; font-size: 28px; transition: 0.2s; }
        .btn-num:active { background: var(--blue); color: #000; }

        /* DOUBLE √âCRAN IA */
        .vision-reel { height: 230px; width: 100%; background: #000; position: relative; border-bottom: 2px solid var(--blue); }
        #liveImg { width: 100%; height: 100%; object-fit: cover; }
        #map { height: 280px; width: 100%; filter: saturate(1.5) brightness(0.7); }

        /* DASHBOARD & STATS */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .stat-card { background: var(--card); border: 1px solid #1c2a3a; border-radius: 18px; padding: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .stat-card .val { font-size: 32px; color: var(--blue); font-weight: 900; display: block; }
        .stat-card .label { font-size: 10px; color: #666; text-transform: uppercase; }

        /* ZONE D'ALERTE IA */
        .ai-status { background: rgba(0, 210, 255, 0.15); border-left: 6px solid var(--blue); margin: 15px; padding: 18px; font-weight: bold; font-size: 14px; }
        .btn-alert { background: var(--red); color: white; border: none; padding: 20px; width: 90%; margin: 5% ; border-radius: 15px; font-weight: bold; font-size: 18px; box-shadow: 0 0 20px rgba(255, 60, 92, 0.4); }
        
        /* GESTION DES CL√âS API */
        .settings-card { background: #111; margin: 15px; padding: 15px; border-radius: 10px; border: 1px dashed #444; }
        input { width: 90%; padding: 12px; margin: 8px 0; background: #000; color: #0f0; border: 1px solid #333; border-radius: 8px; }
    </style>
</head>
<body>

<div id="pinOverlay">
    <h1 style="color:var(--blue)">A.LEMONFA SECURE</h1>
    <div id="dots">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="num-pad" id="numpad"></div>
</div>

<div class="header">üõ∞Ô∏è SENTINELLE V11.8 - UNLIMITED</div>

<div class="vision-reel">
    <img id="liveImg" src="">
    <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.7); padding:5px; font-size:10px;">üì∑ SCAN VISUEL IA</div>
</div>

<div class="ai-status" id="aiBox">ü§ñ IA : Analyse de l'itin√©raire vers Agla...</div>

<div id="map"></div>

<div class="dash-grid">
    <div class="stat-card"><span class="val" id="spd">0</span><span class="label">Km/h</span></div>
    <div class="stat-card"><span class="val" id="dst">0</span><span class="label">M√®tres Restants</span></div>
    <div class="stat-card" style="grid-column: span 2;">
        <div class="label">RUE ACTUELLE / QUARTIER</div>
        <div id="rue" style="color:var(--gold); font-size:18px; font-weight:bold; margin-top:5px;">D√©tection...</div>
    </div>
</div>

<button class="btn-alert" onclick="signalerDanger()">‚ö†Ô∏è SIGNALER ACCIDENT / SCANDALE</button>

<details class="settings-card">
    <summary>üîë CONFIGURATION CL√âS API (S√âCURIS√â)</summary>
    <input type="text" id="kTom" placeholder="TomTom API Key">
    <input type="text" id="kStadia" placeholder="StadiaMaps API Key">
    <input type="text" id="kGoogle" placeholder="Google Maps Key">
    <input type="text" id="kStudio" placeholder="AI Studio (Gemini) Key">
    <button onclick="saveKeys()" style="width:100%; padding:10px; background:var(--blue); border:none; border-radius:5px; font-weight:bold;">SAUVEGARDER</button>
</details>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let currentPin = "";
    let map, marker, userLat, userLng;

    // --- S√âCURIT√â PIN ---
    function buildPad() {
        const pad = document.getElementById('numpad');
        for(let i=1; i<=9; i++) pad.innerHTML += `<button class="btn-num" onclick="pressPin('${i}')">${i}</button>`;
        pad.innerHTML += `<span></span><button class="btn-num" onclick="pressPin('0')">0</button>`;
    }

    function pressPin(n) {
        currentPin += n;
        document.querySelectorAll('.pin-dot')[currentPin.length - 1].style.background = "#00d2ff";
        if(currentPin.length === 4) {
            if(currentPin === "2026") {
                document.getElementById('pinOverlay').style.opacity = "0";
                setTimeout(() => { document.getElementById('pinOverlay').style.display = "none"; }, 500);
                aiSpeak("Syst√®me Sentinelle d√©verrouill√©. Bonjour Monsieur Lemonfa.");
                initMap();
                loopData();
            } else {
                currentPin = "";
                document.querySelectorAll('.pin-dot').forEach(d => d.style.background = "none");
            }
        }
    }

    // --- IA VOCALE ---
    function aiSpeak(t) {
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'fr-FR'; u.rate = 0.95;
        window.speechSynthesis.speak(u);
    }

    // --- CARTOGRAPHIE ET DONN√âES ---
    function initMap() {
        const sKey = localStorage.getItem('kStadia');
        map = L.map('map').setView([6.37, 2.43], 16);
        L.tileLayer(`https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=${sKey}`).addTo(map);
        marker = L.marker([6.37, 2.43]).addTo(map);
    }

    async function loopData() {
        setInterval(async () => {
            try {
                const res = await fetch('http://192.168.4.1/data');
                const d = await res.json();
                userLat = d.lat; userLng = d.lng;

                // Update UI
                document.getElementById('spd').innerText = Math.round(d.speed);
                marker.setLatLng([d.lat, d.lng]);
                map.panTo([d.lat, d.lng]);

                // Update StreetView
                const gKey = localStorage.getItem('kGoogle');
                document.getElementById('liveImg').src = `https://maps.googleapis.com/maps/api/streetview?size=600x300&location=${d.lat},${d.lng}&heading=${d.head}&key=${gKey}`;

                // Analyse TomTom (Trafic & Suggestions)
                updateTomTom(d.lat, d.lng);
            } catch(e) {}
        }, 4000);
    }

    async function updateTomTom(lat, lng) {
        const tKey = localStorage.getItem('kTom');
        const url = `https://api.tomtom.com/search/2/reverseGeocode/${lat},${lng}.json?key=${tKey}`;
        const res = await fetch(url);
        const data = await res.json();
        const rue = data.addresses[0].address.streetName || "Zone Inconnue";
        document.getElementById('rue').innerText = rue;
    }

    function saveKeys() {
        localStorage.setItem('kTom', document.getElementById('kTom').value);
        localStorage.setItem('kStadia', document.getElementById('kStadia').value);
        localStorage.setItem('kGoogle', document.getElementById('kGoogle').value);
        localStorage.setItem('kStudio', document.getElementById('kStudio').value);
        alert("Cl√©s synchronis√©es sur le t√©l√©phone !");
    }

    buildPad();
</script>
</body>
</html>
