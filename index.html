<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENTINELLE ULTRA V11.8 - A.LEMONFA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --blue: #00d2ff; --red: #ff3c5c; --gold: #ffcc00; --bg: #010204; --card: #0d121b; --green: #00ff88; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        
        /* HEADER TACTIQUE */
        .header { background: linear-gradient(90deg, #001f3f, #00d2ff); padding: 15px; text-align: center; border-bottom: 3px solid var(--blue); font-weight: bold; letter-spacing: 2px; position: relative; }
        
        /* BATTERIE */
        .batt-box { position: absolute; right: 10px; top: 18px; font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 5px; }
        .batt-icon { width: 20px; height: 10px; border: 1px solid currentColor; border-radius: 2px; position: relative; }
        .batt-level { height: 100%; background: var(--green); transition: 0.5s; }

        /* BARRE DE CONNEXION */
        .conn-status { display: flex; justify-content: space-around; background: #000; padding: 5px; border-bottom: 1px solid #222; font-size: 10px; }
        .status-item { display: flex; align-items: center; gap: 5px; color: #444; }
        .status-item.active { color: var(--green); text-shadow: 0 0 5px var(--green); }
        .dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }

        /* √âCRAN PIN S√âCURIS√â */
        #pinOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; transition: 0.5s; }
        .pin-dot { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--blue); display: inline-block; margin: 5px; }
        .num-pad { display: grid; grid-template-columns: repeat(3, 85px); gap: 15px; margin-top: 30px; }
        .btn-num { width: 85px; height: 85px; border-radius: 50%; border: 1px solid var(--blue); background: none; color: white; font-size: 28px; }

        /* √âCRANS IA & CARTES */
        .vision-reel { height: 220px; width: 100%; background: #000; position: relative; border-bottom: 2px solid var(--blue); }
        #liveImg { width: 100%; height: 100%; object-fit: cover; }
        #map { height: 280px; width: 100%; filter: saturate(1.2) brightness(0.8); }

        /* DASHBOARD */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; }
        .stat-card { background: var(--card); border: 1px solid #1c2a3a; border-radius: 15px; padding: 12px; text-align: center; }
        .stat-card .val { font-size: 26px; color: var(--blue); font-weight: 900; display: block; }
        .stat-card .label { font-size: 9px; color: #666; text-transform: uppercase; }

        .mission-box { background: #000; margin: 12px; padding: 15px; border: 1px solid var(--gold); border-radius: 12px; }
        .ai-status { background: rgba(0, 210, 255, 0.1); border-left: 5px solid var(--blue); margin: 12px; padding: 15px; font-size: 13px; min-height: 40px; }
        .btn-alert { background: var(--red); color: white; border: none; padding: 18px; width: 90%; margin: 10px 5%; border-radius: 12px; font-weight: bold; font-size: 16px; }
        
        .settings-card { background: #0a0a0a; margin: 12px; padding: 15px; border-radius: 10px; border: 1px dashed #333; }
        input { width: 92%; padding: 12px; margin: 8px 0; background: #000; color: var(--green); border: 1px solid #222; border-radius: 8px; font-size: 14px; }
        summary { color: var(--blue); font-size: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="pinOverlay">
    <h1 style="color:var(--blue)">A.LEMONFA SECURE</h1>
    <div id="dots">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="num-pad" id="numpad"></div>
</div>

<div class="header">
    üõ∞Ô∏è SENTINELLE V11.8
    <div class="batt-box">
        <span id="battText">--%</span>
        <div class="batt-icon"><div id="battFill" class="batt-level" style="width: 0%"></div></div>
    </div>
</div>

<div class="conn-status">
    <div id="statusWemos" class="status-item"><div class="dot"></div> WEMOS (WiFi)</div>
    <div id="statusIA" class="status-item"><div class="dot"></div> IA (Cloud)</div>
</div>

<div class="vision-reel">
    <img id="liveImg" src="">
    <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.7); padding:5px; font-size:9px;">üì∑ SCAN VISUEL IA</div>
</div>

<div class="mission-box">
    <div class="label" style="color:var(--gold); font-size: 10px; margin-bottom: 5px;">üìç DESTINATION DE MISSION</div>
    <input type="text" id="destinationInput" placeholder="Ex: Agla, A√©roport, Bant√®...">
    <button onclick="preparerMission()" style="width:100%; padding:12px; background:var(--gold); color:#000; border:none; border-radius:5px; font-weight:bold;">ANALYSER LA PISTE</button>
</div>

<div class="ai-status" id="aiBox">ü§ñ IA : En attente d'instruction...</div>

<div id="map"></div>

<div class="dash-grid">
    <div class="stat-card"><span class="val" id="spd">0</span><span class="label">Km/h</span></div>
    <div class="stat-card"><span class="val" id="dstTotal">0</span><span class="label">Total (km)</span></div>
    <div class="stat-card"><span class="val" id="dstUsed">0</span><span class="label">Parcouru (km)</span></div>
    <div class="stat-card"><span class="val" id="dst">0</span><span class="label">Restant (m)</span></div>
    <div class="stat-card" style="grid-column: span 2;">
        <div class="label">QUARTIER ACTUEL</div>
        <div id="rue" style="color:var(--gold); font-size:16px; font-weight:bold; margin-top:5px;">Scan GPS...</div>
    </div>
</div>

<button class="btn-alert" onclick="signalerDanger()">‚ö†Ô∏è SIGNALER DANGER / SCANDALE</button>

<details class="settings-card">
    <summary>‚öôÔ∏è CONFIGURATION & UTILISATEUR</summary>
    <div style="margin-top:10px;">
        <label style="font-size:10px; color:#666;">NOM DE L'UTILISATEUR</label>
        <input type="text" id="userName" placeholder="Monsieur Lemonfa">
        
        <label style="font-size:10px; color:#666;">CL√âS API</label>
        <input type="text" id="kTom" placeholder="TomTom Key">
        <input type="text" id="kStadia" placeholder="StadiaMaps Key">
        <input type="text" id="kGoogle" placeholder="Google Key">
        <input type="text" id="kStudio" placeholder="Gemini Key">
        <button onclick="saveSettings()" style="width:100%; padding:10px; background:var(--blue); border:none; border-radius:5px; font-weight:bold;">SAUVEGARDER TOUT</button>
    </div>
</details>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let currentPin = "";
    let map, marker;
    let distanceTotale = 0, distanceParcourue = 0;

    function buildPad() {
        const pad = document.getElementById('numpad');
        for(let i=1; i<=9; i++) pad.innerHTML += `<button class="btn-num" onclick="pressPin('${i}')">${i}</button>`;
        pad.innerHTML += `<span></span><button class="btn-num" onclick="pressPin('0')">0</button>`;
        document.getElementById('userName').value = localStorage.getItem('userName') || "Monsieur Lemonfa";
        
        // Pr√©-remplir les cl√©s sauvegard√©es
        document.getElementById('kTom').value = localStorage.getItem('kTom') || "";
        document.getElementById('kStadia').value = localStorage.getItem('kStadia') || "";
        document.getElementById('kGoogle').value = localStorage.getItem('kGoogle') || "";
        document.getElementById('kStudio').value = localStorage.getItem('kStudio') || "";
    }

    function pressPin(n) {
        currentPin += n;
        document.querySelectorAll('.pin-dot')[currentPin.length - 1].style.background = "#00d2ff";
        if(currentPin.length === 4) {
            if(currentPin === "2026") {
                document.getElementById('pinOverlay').style.opacity = "0";
                setTimeout(() => { document.getElementById('pinOverlay').style.display = "none"; }, 500);
                salutationIA();
                initMap();
                loopData();
                updateBattery();
            } else {
                currentPin = "";
                document.querySelectorAll('.pin-dot').forEach(d => d.style.background = "none");
            }
        }
    }

    function salutationIA() {
        const nom = document.getElementById('userName').value;
        const heure = new Date().getHours();
        let bonjour = (heure >= 5 && heure < 18) ? "Bonjour" : "Bonsoir";
        aiSpeak(`${bonjour} ${nom}. Syst√®me Sentinelle activ√©.`);
    }

    function aiSpeak(t) {
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'fr-FR'; u.rate = 0.95;
        window.speechSynthesis.speak(u);
    }

    function updateBattery() {
        if(navigator.getBattery) {
            navigator.getBattery().then(batt => {
                const update = () => {
                    const level = Math.round(batt.level * 100);
                    document.getElementById('battText').innerText = level + "%";
                    document.getElementById('battFill').style.width = level + "%";
                };
                update();
                batt.addEventListener('levelchange', update);
            });
        }
    }

    async function interrogerGemini(prompt) {
        const key = localStorage.getItem('kStudio');
        if(!key) return "Erreur : Cl√© IA non configur√©e.";
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch(e) { return "Erreur d'analyse IA. V√©rifiez votre connexion 4G."; }
    }

    async function preparerMission() {
        const dest = document.getElementById('destinationInput').value;
        const nom = document.getElementById('userName').value;
        if(!dest) return;
        
        document.getElementById('aiBox').innerText = "ü§ñ Analyse tactique en cours...";
        aiSpeak(`Analyse du trajet vers ${dest}.`);

        // IA calcule la distance et donne un conseil
        const prompt = `Tu es l'IA Sentinelle. L'utilisateur ${nom} va √† ${dest} depuis Cotonou. 
        Donne la distance approximative et un conseil de s√©curit√© bref pour cette route. 
        Sois pr√©cis pour les villes du B√©nin.`;

        const analyse = await interrogerGemini(prompt);
        document.getElementById('aiBox').innerText = "ü§ñ " + analyse;
        aiSpeak(analyse);

        // Logique de distance dynamique
        if(dest.toLowerCase().includes("bant√®")) {
            distanceTotale = 281; 
        } else if(dest.toLowerCase().includes("a√©roport")) {
            distanceTotale = 5.2;
        } else {
            distanceTotale = (Math.random() * 10 + 2).toFixed(1);
        }
        
        document.getElementById('dstTotal').innerText = distanceTotale;
        distanceParcourue = 0;
    }

    function initMap() {
        const sKey = localStorage.getItem('kStadia');
        map = L.map('map').setView([6.37, 2.43], 15);
        L.tileLayer(`https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=${sKey}`).addTo(map);
        marker = L.marker([6.37, 2.43]).addTo(map);
    }

    async function loopData() {
        setInterval(async () => {
            document.getElementById('statusIA').classList.toggle('active', navigator.onLine);

            try {
                const res = await fetch('http://192.168.4.1/data', { signal: AbortSignal.timeout(2000) });
                const d = await res.json();
                document.getElementById('statusWemos').classList.add('active');

                document.getElementById('spd').innerText = Math.round(d.speed);
                marker.setLatLng([d.lat, d.lng]);
                map.panTo([d.lat, d.lng]);

                if(distanceTotale > 0) {
                    distanceParcourue += (d.speed / 3600) * 4;
                    document.getElementById('dstUsed').innerText = distanceParcourue.toFixed(2);
                    let rest = (distanceTotale * 1000) - (distanceParcourue * 1000);
                    document.getElementById('dst').innerText = Math.max(0, Math.round(rest));
                }

                const gKey = localStorage.getItem('kGoogle');
                document.getElementById('liveImg').src = `https://maps.googleapis.com/maps/api/streetview?size=600x300&location=${d.lat},${d.lng}&heading=${d.head}&key=${gKey}`;
                updateTomTom(d.lat, d.lng);
            } catch(e) {
                document.getElementById('statusWemos').classList.remove('active');
            }
        }, 4000);
    }

    async function updateTomTom(lat, lng) {
        const tKey = localStorage.getItem('kTom');
        if(!tKey) return;
        try {
            const res = await fetch(`https://api.tomtom.com/search/2/reverseGeocode/${lat},${lng}.json?key=${tKey}`);
            const data = await res.json();
            document.getElementById('rue').innerText = data.addresses[0].address.streetName || "Zone Inconnue";
        } catch(e) {}
    }

    function signalerDanger() {
        const nom = document.getElementById('userName').value;
        const msg = `Attention ${nom}, anomalie d√©tect√©e √† ${document.getElementById('rue').innerText}.`;
        aiSpeak(msg);
        document.getElementById('aiBox').innerText = "‚ö†Ô∏è " + msg;
    }

    function saveSettings() {
        localStorage.setItem('userName', document.getElementById('userName').value);
        localStorage.setItem('kTom', document.getElementById('kTom').value);
        localStorage.setItem('kStadia', document.getElementById('kStadia').value);
        localStorage.setItem('kGoogle', document.getElementById('kGoogle').value);
        localStorage.setItem('kStudio', document.getElementById('kStudio').value);
        alert("Syst√®me mis √† jour et s√©curis√© !");
    }

    buildPad();
</script>
</body>
</html>
